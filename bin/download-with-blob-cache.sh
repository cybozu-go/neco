#!/bin/bash

# ./download-with-blob-cache.sh <curl-command> <local-file-name> <download-url>
# <curl-command> may have options like "curl -sSfL" (with quote)
# <local-file-name> may contain path part like "../download/foo.iso"

# If NECO_CI_BLOB_CACHE_URL environment variable is set, this script uses blob cache.
# Otherwise, this script just download a file.

# Note: cache entry key is generated by <download-url>.

CURLCMD="$1"
LOCALNAME="$2"
DLURL="$3"
CACHEURL=${NECO_CI_BLOB_CACHE_URL%/}/single/$(echo ${DLURL} | sed -E -e 's|^https?://||' -e 's|///*|/|g')

if [ -n "${NECO_CI_BLOB_CACHE_URL}" ]; then
    if curl -sSfL -o ${LOCALNAME} ${CACHEURL}; then
        echo cache hit
        exit 0
    else
        echo cache miss
    fi
else
    echo not using cache
fi

${CURLCMD} -o ${LOCALNAME} ${DLURL}
EXITSTATUS=$?

if [ -n "${NECO_CI_BLOB_CACHE_URL}" -a "${EXITSTATUS}" = "0" ]; then
    if curl -sSfL -T ${LOCALNAME} ${CACHEURL}; then
        echo cache write succeeded
    else
        echo cache write failed
    fi
fi

exit ${EXITSTATUS}
