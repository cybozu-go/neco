JSONNET_VERSION := 0.18.0
YQ_VERSION := 4.24.5
AUTOGEN_COMMENT := This file is automatically generated from a template. Please do not edit.

ROOT_DIR := $(shell git rev-parse --show-toplevel)
BINDIR := $(abspath $(CURDIR)/bin)
JSONNET := $(BINDIR)/jsonnet
JSONNETFMT := $(BINDIR)/jsonnetfmt
YQ := $(BINDIR)/yq

DOWNLOAD_DIR := $(ROOT_DIR)/download
JSONNET_DLPATH := $(DOWNLOAD_DIR)/jsonnet-v$(JSONNET_VERSION).tar.gz
YQ_DLPATH := $(DOWNLOAD_DIR)/yq-v$(YQ_VERSION).tar.gz

TEMP_DIR := /tmp/site-env

WGET := wget --retry-connrefused --no-verbose
WGET_PATH := $(shell which wget || echo wget-install)

.PHONY: all
all: site-env common-env

write-%:
	mkdir -p $(TEMP_DIR)
	$(JSONNET) $*.jsonnet > $(TEMP_DIR)/$*.json
	set -e; for i in $$(cat $(TEMP_DIR)/$*.json | jq -r 'keys | .[]'); do \
		echo $$i; \
		mkdir -p $(ROOT_DIR)/$$(dirname $$i); \
		cat $(TEMP_DIR)/$*.json |jq 'del(.[][] | select(length == 0))' | $(YQ) ".[\"$$i\"] | .[0] headComment=\"$(AUTOGEN_COMMENT)\" | .[]" - --prettyPrint > $(ROOT_DIR)/$$i; \
	done

.PHONY: site-env
site-env: write-site-env

.PHONY: common-env
common-env: write-common-env

.PHONY: format-settings
format-settings:
	mkdir -p $(TEMP_DIR)
	$(YQ) eval 'sortKeys(..)' settings.json -j > $(TEMP_DIR)/settings.json
	mv $(TEMP_DIR)/settings.json settings.json
	rm -rf $(TEMP_DIR)

.PHONY: format
format: format-settings
	mkdir -p $(TEMP_DIR)
	set -e; for i in $$(find . -name '*.json'); do \
		echo $$i; \
		jq . $$i > $(TEMP_DIR)/$$i; \
		mv $(TEMP_DIR)/$$i $$i; \
	done
	rm -rf $(TEMP_DIR)
	set -e; for i in $$(find . -name '*.jsonnet'); do \
		echo $$i; \
		$(JSONNETFMT) -i $$i; \
	done
	set -e; for i in $$(find . -name '*.libsonnet'); do \
		echo $$i; \
		$(JSONNETFMT) -i $$i; \
	done

.PHONY: validation
validation: format all
	if ! test -z "$$(git status -s)"; then \
		git status; \
		exit 1; \
	fi

.PHONY: setup
setup: $(JSONNET) $(YQ)

$(JSONNET): $(JSONNET_DLPATH)
	mkdir -p $(BINDIR)
	tar zxf $(JSONNET_DLPATH) -C $(BINDIR)

$(JSONNET_DLPATH): $(WGET_PATH)
	mkdir -p $(DOWNLOAD_DIR)
	$(WGET) -O $@ https://github.com/google/go-jsonnet/releases/download/v$(JSONNET_VERSION)/go-jsonnet_$(JSONNET_VERSION)_Linux_x86_64.tar.gz

$(YQ): $(YQ_DLPATH)
	mkdir -p $(BINDIR)
	tar zxf $(YQ_DLPATH) -O ./yq_linux_amd64 > $@
	chmod +x $@

$(YQ_DLPATH): $(WGET_PATH)
	mkdir -p $(DOWNLOAD_DIR)
	$(WGET) -O $@ https://github.com/mikefarah/yq/releases/download/v$(YQ_VERSION)/yq_linux_amd64.tar.gz

.PHONY: wget-install
$(WGET_PATH):
	$(SUDO) apt-get update && $(SUDO) apt-get -y install wget

.PHONY: clean
clean:
	rm -rf $(BINDIR)
	rm -rf $(DOWNLOAD_DIR)
